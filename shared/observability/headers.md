# Request Correlation Headers

Standard HTTP headers for correlation context propagation across the ecosystem.

## Required Headers

| Header | Description | Set By | Example |
|--------|-------------|--------|---------|
| `x-journey-id` | User journey identifier | Web Shell | `jrn_V1StGXR8_Z5jdHi6B-myT` |
| `x-user-ecosystem-id` | User ecosystem identifier | Web BFF (after auth) | `usr_demo_user_001` |
| `x-request-id` | Unique request identifier | Each service | `req_abc123` |
| `traceparent` | W3C Trace Context | OpenTelemetry SDK | `00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01` |
| `tracestate` | W3C Trace State | OpenTelemetry SDK | `ecosystem=...` |

## Header Flow

```
Browser
  │
  ├─► x-journey-id (generated by Web Shell)
  │
  ▼
Web BFF
  │
  ├─► x-journey-id (propagated)
  ├─► x-user-ecosystem-id (added after auth)
  ├─► x-request-id (generated)
  ├─► traceparent (from OTEL SDK)
  │
  ▼
Domain Services
  │
  ├─► All headers propagated
  ├─► x-request-id (new per request)
  │
  ▼
Analytics / Kafka
  │
  └─► All correlation IDs included in event payload
```

## Implementation

### Java (Spring Boot)

```java
// Filter to extract and propagate correlation headers
@Component
public class CorrelationFilter extends OncePerRequestFilter {
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                    HttpServletResponse response, 
                                    FilterChain chain) {
        String journeyId = request.getHeader("x-journey-id");
        String userEcosystemId = request.getHeader("x-user-ecosystem-id");
        
        // Add to MDC for logging
        MDC.put("journeyId", journeyId);
        MDC.put("userEcosystemId", userEcosystemId);
        
        try {
            chain.doFilter(request, response);
        } finally {
            MDC.clear();
        }
    }
}
```

### TypeScript (Fastify)

```typescript
// Hook to extract and propagate correlation headers
fastify.addHook('preHandler', async (request, reply) => {
  const journeyId = request.headers['x-journey-id'];
  const userEcosystemId = request.headers['x-user-ecosystem-id'];
  
  request.correlationContext = { journeyId, userEcosystemId };
  request.log = request.log.child({ journeyId, userEcosystemId });
});
```

### Frontend (React/Next.js)

```typescript
// Include journey ID in all API calls
const apiClient = {
  async fetch(url: string, options: RequestInit = {}) {
    const journeyId = sessionStorage.getItem('journeyId');
    
    return fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        'x-journey-id': journeyId || '',
      },
    });
  },
};
```

